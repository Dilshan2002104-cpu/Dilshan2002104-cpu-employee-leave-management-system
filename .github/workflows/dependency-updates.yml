name: Dependency Updates

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  # Update Backend Dependencies
  update-backend-dependencies:
    name: Update Maven Dependencies
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Update Maven Dependencies
      working-directory: ./ELMS
      run: |
        mvn versions:use-latest-versions
        mvn versions:update-properties

    - name: Check for changes
      id: backend-changes
      run: |
        if git diff --quiet; then
          echo "changes=false" >> $GITHUB_OUTPUT
        else
          echo "changes=true" >> $GITHUB_OUTPUT
        fi

    - name: Create Pull Request for Backend
      if: steps.backend-changes.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore(backend): update Maven dependencies'
        title: 'ğŸ”„ Update Backend Dependencies'
        body: |
          ## ğŸ“¦ Automated Dependency Updates - Backend
          
          This PR contains automated updates to Maven dependencies in the backend.
          
          ### ğŸ” What changed:
          - Updated Maven dependencies to latest versions
          - Updated Maven properties
          
          ### âš ï¸ Important:
          - Please review the changes carefully
          - Run tests to ensure compatibility
          - Check for any breaking changes in the updated dependencies
          
          ### ğŸ§ª Testing:
          - [ ] Backend tests pass
          - [ ] Integration tests pass
          - [ ] Manual testing completed
          
          Auto-generated by GitHub Actions ğŸ¤–
        branch: automated/update-backend-dependencies
        delete-branch: true
        labels: |
          dependencies
          backend
          automated

  # Update Frontend Dependencies
  update-frontend-dependencies:
    name: Update NPM Dependencies
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Update NPM Dependencies
      working-directory: ./frontend
      run: |
        npm update
        npm audit fix --force || true

    - name: Check for changes
      id: frontend-changes
      run: |
        if git diff --quiet; then
          echo "changes=false" >> $GITHUB_OUTPUT
        else
          echo "changes=true" >> $GITHUB_OUTPUT
        fi

    - name: Create Pull Request for Frontend
      if: steps.frontend-changes.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore(frontend): update NPM dependencies'
        title: 'ğŸ”„ Update Frontend Dependencies'
        body: |
          ## ğŸ“¦ Automated Dependency Updates - Frontend
          
          This PR contains automated updates to NPM dependencies in the frontend.
          
          ### ğŸ” What changed:
          - Updated NPM packages to latest versions
          - Applied security fixes
          
          ### âš ï¸ Important:
          - Please review the changes carefully
          - Run tests to ensure compatibility
          - Check for any breaking changes in the updated dependencies
          
          ### ğŸ§ª Testing:
          - [ ] Frontend builds successfully
          - [ ] ESLint passes
          - [ ] Manual testing completed
          
          Auto-generated by GitHub Actions ğŸ¤–
        branch: automated/update-frontend-dependencies
        delete-branch: true
        labels: |
          dependencies
          frontend
          automated

  # Security Vulnerability Check
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Maven Security Audit
      working-directory: ./ELMS
      run: |
        mvn org.owasp:dependency-check-maven:check

    - name: NPM Security Audit
      working-directory: ./frontend
      run: |
        npm audit --audit-level high

    - name: Create Security Issue
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ğŸ”’ Security vulnerabilities detected',
            body: `
            ## ğŸš¨ Security Alert
            
            Our automated security audit has detected vulnerabilities in the project dependencies.
            
            ### ğŸ“ Location:
            Check the failed workflow for details on which dependencies are affected.
            
            ### ğŸ”§ Action Required:
            1. Review the security audit results
            2. Update the vulnerable dependencies
            3. Test the application thoroughly
            4. Deploy the fixes as soon as possible
            
            ### ğŸ“Š Workflow:
            - **Run ID:** ${{ github.run_id }}
            - **Run URL:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            This issue was automatically created by GitHub Actions.
            `,
            labels: ['security', 'high-priority', 'automated']
          })